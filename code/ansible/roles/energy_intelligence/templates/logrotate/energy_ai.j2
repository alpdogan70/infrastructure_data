# Logrotate configuration for Energy AI
# File: /etc/logrotate.d/energy_ai
# Generated by Ansible - Energy Intelligence Role

{{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/*.log {
    # Rotation settings
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    
    # File permissions
    create 0644 root root
    
    # Post-rotation script
    postrotate
        # Reload services to reopen log files
        /bin/systemctl reload-or-restart energy-ai-predictor >/dev/null 2>&1 || true
        /bin/systemctl reload-or-restart energy-scenarios >/dev/null 2>&1 || true
        /bin/systemctl reload-or-restart weather-ml >/dev/null 2>&1 || true
        /bin/systemctl reload-or-restart cost-optimizer >/dev/null 2>&1 || true
        
        # Log rotation completion
        /bin/echo "$(date): Energy AI logs rotated" >> {{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/rotation.log
    endscript
    
    # Size-based rotation (backup)
    size 50M
    
    # Keep old versions
    maxage 365
}

# Specific configuration for service logs
{{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/service.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 root root
    copytruncate
}

# Configuration for training and diagnostic logs
{{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/training_*.log
{{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/diagnostic_*.log
{{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/performance_*.log {
    weekly
    missingok
    rotate 12
    compress
    delaycompress
    notifempty
    create 0644 root root
    
    # Remove old diagnostic files
    postrotate
        find {{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }} -name "diagnostic_report_*.txt" -mtime +30 -delete >/dev/null 2>&1 || true
        find {{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }} -name "training_report_*.json" -mtime +60 -delete >/dev/null 2>&1 || true
    endscript
}