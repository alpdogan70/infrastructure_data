---
# VÃ©rification prÃ©requis systÃ¨me IA Ã©nergÃ©tique
# File: ansible/roles/energy_intelligence/tasks/verify_prerequisites.yml

- name: "ğŸ” VÃ©rification architecture systÃ¨me"
  set_fact:
    system_arch: "{{ ansible_architecture }}"
    os_family: "{{ ansible_os_family }}"
    distribution: "{{ ansible_distribution }}"
    distribution_version: "{{ ansible_distribution_version }}"

- name: "ğŸ“Š VÃ©rification ressources systÃ¨me minimales"
  assert:
    that:
      - ansible_memtotal_mb >= 2048
      - ansible_processor_vcpus >= 2
      - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first > 10737418240  # 10GB
    fail_msg: |
      âŒ Ressources insuffisantes pour Energy AI:
      RAM: {{ ansible_memtotal_mb }}MB (minimum: 2048MB)
      CPU: {{ ansible_processor_vcpus }} cores (minimum: 2)
      Espace disque: {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first / 1073741824) | round(1) }}GB (minimum: 10GB)
    success_msg: |
      âœ… Ressources systÃ¨me suffisantes:
      RAM: {{ ansible_memtotal_mb }}MB
      CPU: {{ ansible_processor_vcpus }} cores
      Espace disque: {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first / 1073741824) | round(1) }}GB

- name: "ğŸ§ VÃ©rification compatibilitÃ© OS"
  assert:
    that:
      - ansible_os_family == "Debian"
      - ansible_distribution in ["Ubuntu", "Debian"]
      - ansible_distribution_version is version('18.04', '>=') or ansible_distribution_version is version('10', '>=')
    fail_msg: |
      âŒ OS non supportÃ©: {{ ansible_distribution }} {{ ansible_distribution_version }}
      SystÃ¨mes supportÃ©s: Ubuntu 18.04+, Debian 10+
    success_msg: "âœ… OS compatible: {{ ansible_distribution }} {{ ansible_distribution_version }}"

- name: "ğŸŒ VÃ©rification connectivitÃ© rÃ©seau"
  uri:
    url: "{{ item.url }}"
    method: GET
    timeout: 10
    status_code: 200
  loop:
    - { name: "MQTT Broker Web", url: "http://{{ mqtt_broker_host | default('mqtt1') }}:8080" }
    - { name: "InfluxDB", url: "http://{{ influxdb_host | default('influxdb1') }}:8086/health" }
  register: network_connectivity
  ignore_errors: true
  when: mqtt_broker_host is defined and influxdb_host is defined

- name: "ğŸ“¡ RÃ©sultats connectivitÃ©"
  debug:
    msg: |
      ğŸ“Š ConnectivitÃ© rÃ©seau:
      {% if network_connectivity is defined and network_connectivity.results is defined %}
      {% for result in network_connectivity.results %}
      {{ 'âœ…' if result.status|default(0) == 200 else 'âŒ' }} {{ result.item.name }}: {{ result.item.url }}
      {% endfor %}
      {% else %}
      âš ï¸ Tests de connectivitÃ© ignorÃ©s (variables d'hÃ´tes non dÃ©finies)
      {% endif %}

- name: "ğŸ”§ VÃ©rification Python 3 disponible"
  command: "python3 --version"
  register: python3_check
  changed_when: false

- name: "ğŸ“¦ VÃ©rification gestionnaire paquets"
  command: "apt --version"
  register: apt_check
  changed_when: false

- name: "ğŸ”’ VÃ©rification privilÃ¨ges sudo"
  command: "sudo -n true"
  register: sudo_check
  changed_when: false
  failed_when: false

- name: "âš ï¸ Alertes prÃ©requis"
  debug:
    msg: |
      âš ï¸ Attention: Sudo sans mot de passe requis pour l'installation
  when: sudo_check.rc != 0

- name: "ğŸ¯ VÃ©rification rÃ©pertoires existants"
  stat:
    path: "{{ item }}"
  loop:
    - "/opt"
    - "/var/log"
    - "/etc"
    - "/usr/local/bin"
  register: directories_check

- name: "ğŸ“‹ RÃ©sumÃ© vÃ©rifications prÃ©requis"
  debug:
    msg: |
      âœ… VÃ©rifications prÃ©requis terminÃ©es:
      
      ğŸ–¥ï¸ SystÃ¨me: {{ ansible_distribution }} {{ ansible_distribution_version }} ({{ ansible_architecture }})
      ğŸ’¾ RAM: {{ ansible_memtotal_mb }}MB
      ğŸ”§ CPU: {{ ansible_processor_vcpus }} cores
      ğŸ Python: {{ python3_check.stdout }}
      ğŸ“¦ APT: Disponible
      ğŸ”’ Sudo: {{ 'OK' if sudo_check.rc == 0 else 'Attention requise' }}
      
      ğŸŒ ConnectivitÃ©:
      {% if network_connectivity is defined and network_connectivity.results is defined %}
      {% for result in network_connectivity.results %}
      {{ 'âœ…' if result.status|default(0) == 200 else 'âŒ' }} {{ result.item.name }}
      {% endfor %}
      {% else %}
      âš ï¸ Tests rÃ©seau ignorÃ©s
      {% endif %}
      
      ğŸ¯ PrÃªt pour installation Energy AI: {{ 'âœ… OUI' if (ansible_memtotal_mb >= 2048 and ansible_processor_vcpus >= 2) else 'âŒ NON' }}