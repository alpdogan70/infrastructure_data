---
# Installation dÃ©pendances IA/ML
# File: ansible/roles/energy_intelligence/tasks/install_dependencies.yml

- name: "ğŸ“¦ Mise Ã  jour cache APT"
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: "ğŸ”§ Installation dÃ©pendances systÃ¨me pour IA/ML"
  apt:
    name:
      # Python et outils de base
      - "python{{ python_ai.version | default('3') }}"
      - "python{{ python_ai.version | default('3') }}-dev"
      - "python{{ python_ai.version | default('3') }}-venv"
      - python3-pip
      - python3-setuptools
      - python3-wheel
      - python3-venv
      - python3-full
      - build-essential
      - pkg-config
      - cmake
      - git
      
      # BibliothÃ¨ques mathÃ©matiques pour ML
      - libhdf5-dev
      - libhdf5-serial-dev
      - libnetcdf-dev
      - libblas-dev
      - liblapack-dev
      - libatlas-base-dev
      - gfortran
      - libopenblas-dev
      
      # DÃ©pendances pour TensorFlow/scikit-learn
      - libffi-dev
      - libssl-dev
      - libjpeg-dev
      - libpng-dev
      - libfreetype6-dev
      - zlib1g-dev
      - liblzma-dev
      - libbz2-dev
      
      # Outils systÃ¨me essentiels
      - htop
      - curl
      - wget
      - unzip
      - zip
      - rsync
      - vim
      - nano
      
      # Outils rÃ©seau
      - net-tools
      - iputils-ping
      - telnet
      - netcat-openbsd
      
    state: present
    install_recommends: false

- name: "ğŸ“Š Installation outils monitoring et performance"
  apt:
    name:
      - sysstat          # iostat, sar, etc.
      - iotop            # I/O monitoring
      - nethogs          # Network monitoring
      - lsof             # List open files
      - tree             # Directory tree
      - tmux             # Terminal multiplexer
      - screen           # Terminal sessions
    state: present

- name: "ğŸ” VÃ©rification version Python IA"
  command: "python{{ python_ai.version | default('3') }} --version"
  register: python_version_check
  changed_when: false

- name: "ğŸ“‹ Affichage version Python installÃ©e"
  debug:
    msg: "ğŸ Python IA installÃ©: {{ python_version_check.stdout }}"

- name: "ğŸ”§ Mise Ã  jour pip dans l'environnement virtuel (sera crÃ©Ã© plus tard)"
  debug:
    msg: "âš ï¸ Pip sera mis Ã  jour lors de la crÃ©ation de l'environnement virtuel Python"

- name: "ğŸ§® Test disponibilitÃ© packages Python systÃ¨me"
  command: |
    python{{ python_ai.version | default('3') }} -c "
    try:
        import venv
        print('âœ… Module venv disponible')
    except ImportError:
        print('âŒ Module venv non disponible')
    try:
        import distutils.util
        print('âœ… Module distutils disponible')
    except ImportError:
        print('âš ï¸ Module distutils non disponible')
    "
  register: python_modules_check
  failed_when: false
  changed_when: false

- name: "ğŸ“ˆ Test capacitÃ©s systÃ¨me ML"
  command: |
    python{{ python_ai.version | default('3') }} -c "
    import sys
    import platform
    import multiprocessing
    print(f'ğŸ Python: {sys.version}')
    print(f'ğŸ—ï¸ Architecture: {platform.machine()}')
    print(f'ğŸ”§ CPU cores: {multiprocessing.cpu_count()}')
    print(f'ğŸ“¦ Platform: {platform.platform()}')
    "
  register: ml_capabilities
  changed_when: false

- name: "ğŸ” VÃ©rification espace disque disponible"
  setup:
    gather_subset: "!all,hardware"

- name: "ğŸ’¾ Calcul espace disque"
  set_fact:
    disk_space_gb: "{{ (ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first / 1073741824) | round(1) }}"
    disk_total_gb: "{{ (ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first / 1073741824) | round(1) }}"

- name: "âš ï¸ VÃ©rification espace disque suffisant"
  assert:
    that:
      - disk_space_gb | float >= 5.0
    fail_msg: |
      âŒ Espace disque insuffisant: {{ disk_space_gb }}GB disponible
      Minimum requis: 5GB pour l'installation IA/ML
    success_msg: "âœ… Espace disque suffisant: {{ disk_space_gb }}GB disponible"

- name: "ğŸ§ª Test compilation basique"
  command: |
    echo '#include <stdio.h>
    int main() { printf("Hello World\\n"); return 0; }' > /tmp/test.c &&
    gcc /tmp/test.c -o /tmp/test &&
    /tmp/test &&
    rm -f /tmp/test.c /tmp/test
  register: gcc_test
  changed_when: false
  failed_when: false

- name: "ğŸ¯ RÃ©sumÃ© installation dÃ©pendances"
  debug:
    msg: |
      âœ… Installation dÃ©pendances IA/ML terminÃ©e avec succÃ¨s
      
      ğŸ Python: {{ python_version_check.stdout }}
      ğŸ—ï¸ Architecture: {{ ml_capabilities.stdout_lines[1] | default('Non dÃ©tectÃ©e') }}
      ğŸ”§ CPU: {{ ml_capabilities.stdout_lines[2] | default('Non dÃ©tectÃ©') }}
      ğŸ’¾ Espace disque: {{ disk_space_gb }}GB / {{ disk_total_gb }}GB
      ğŸ§® Modules Python: {{ python_modules_check.stdout | default('Test ignorÃ©') }}
      ğŸ”¨ Compilation GCC: {{ 'OK' if gcc_test.rc == 0 else 'Erreur (non critique)' }}
      
      ğŸ“¦ Packages systÃ¨me installÃ©s:
      âœ… Python {{ python_ai.version | default('3') }} + outils dÃ©veloppement
      âœ… python3-full (environnements virtuels Debian 12)
      âœ… BibliothÃ¨ques mathÃ©matiques (BLAS, LAPACK, OpenBLAS)
      âœ… DÃ©pendances ML (HDF5, NetCDF, etc.)
      âœ… Outils systÃ¨me et monitoring
      âœ… Outils rÃ©seau et dÃ©veloppement
      
      âš ï¸ Note Debian 12: pip sera utilisÃ© uniquement dans l'environnement virtuel
      ğŸš€ SystÃ¨me prÃªt pour l'installation de l'environnement Python IA


