---
# Configuration Telegraf pour IA Ã©nergÃ©tique
# File: ansible/roles/energy_intelligence/tasks/configure_telegraf_ai.yml

- name: "ğŸ“¡ VÃ©rification que Telegraf est installÃ©"
  systemd:
    name: telegraf
    state: started
  register: telegraf_status
  ignore_errors: true

- name: "âš ï¸ Telegraf non disponible - Configuration reportÃ©e"
  debug:
    msg: |
      âš ï¸ Telegraf n'est pas encore installÃ© ou dÃ©marrÃ©.
      La configuration Energy AI sera ajoutÃ©e lors du dÃ©ploiement Telegraf.
      
      Pour activer Energy AI dans Telegraf:
      1. DÃ©finir enable_energy_ai_topics: true dans les variables
      2. RedÃ©ployer le rÃ´le telegraf_dedicated
  when: telegraf_status.failed

- name: "ğŸ“Š Configuration Energy AI disponible pour Telegraf"
  debug:
    msg: |
      âœ… Templates Energy AI crÃ©Ã©s pour intÃ©gration Telegraf:
      
      ğŸ“ Templates disponibles:
      - telegraf_energy_ai.conf.j2 (dans telegraf_dedicated)
      - Configuration MQTT pour topics IA
      - Outputs InfluxDB spÃ©cialisÃ©s
      
      ğŸ”§ Pour activer:
      1. enable_energy_ai_topics: true
      2. RedÃ©ployer telegraf_dedicated
      
      ğŸ“¡ Topics IA configurÃ©s:
      {% for topic_name, topic_value in mqtt_ai.topics.items() %}
      - {{ topic_name }}: {{ topic_value }}
      {% endfor %}
  when: not telegraf_status.failed

- name: "ğŸ“‹ Variables Energy AI pour Telegraf"
  set_fact:
    energy_ai_telegraf_ready: true
    energy_ai_mqtt_topics: "{{ mqtt_ai.topics }}"
    energy_ai_version_info: "{{ energy_ai.version | default('1.0.0') }}"

- name: "ğŸ’¡ Instructions intÃ©gration Telegraf"
  debug:
    msg: |
      ğŸ’¡ INTÃ‰GRATION TELEGRAF ENERGY AI
      
      Le rÃ´le telegraf_dedicated contient dÃ©jÃ  le template pour Energy AI.
      
      ğŸ”§ Configuration automatique:
      âœ… Variables Energy AI dÃ©finies
      âœ… Templates prÃªts pour telegraf_dedicated
      
      ğŸ“‹ Prochaines Ã©tapes:
      1. Le dÃ©ploiement Telegraf utilisera automatiquement ces variables
      2. Si enable_energy_ai_topics=true, les topics IA seront activÃ©s
      3. Les buckets InfluxDB seront crÃ©Ã©s automatiquement
      
      ğŸ¯ Topics MQTT Energy AI:
      {{ energy_ai_mqtt_topics | to_nice_json }}

# ---
# # Configuration Telegraf pour IA Ã©nergÃ©tique
# # File: ansible/roles/energy_intelligence/tasks/configure_telegraf_ai.yml

# - name: "ğŸ“¡ DÃ©ploiement configuration Telegraf IA"
#   template:
#     src: configs/energy_ai_telegraf.conf.j2
#     dest: /etc/telegraf/telegraf.d/energy_ai.conf
#     owner: telegraf
#     group: telegraf
#     mode: '0644'
#     backup: yes
#   notify: restart telegraf
#   tags: ['telegraf_config']

# - name: "ğŸ—„ï¸ Configuration outputs InfluxDB IA"
#   template:
#     src: configs/energy_ai_outputs.conf.j2
#     dest: /etc/telegraf/telegraf.d/energy_ai_outputs.conf
#     owner: telegraf
#     group: telegraf
#     mode: '0644'
#     backup: yes
#   notify: restart telegraf
#   tags: ['telegraf_outputs']

# - name: "ğŸ”§ Extension configuration Telegraf existante"
#   blockinfile:
#     path: /etc/telegraf/telegraf.d/datacenter_energy.conf
#     marker: "# {mark} ANSIBLE MANAGED BLOCK - AI INTEGRATION"
#     block: |
#       # ================== AI INTEGRATION ==================
      
#       # AI Predictions Input
#       [[inputs.mqtt_consumer]]
#         servers = ["tcp://{{ mqtt_broker_host }}:1883"]
#         topics = [
#           "{{ mqtt_ai.topics.predictions }}/+",
#           "{{ mqtt_ai.topics.scenarios }}/+",
#           "{{ mqtt_ai.topics.recommendations }}",
#           "{{ mqtt_ai.topics.performance }}"
#         ]
#         topic_tag = "topic"
#         qos = 1
#         connection_timeout = "30s"
#         username = "iot"
#         password = "iot123"
#         client_id = "telegraf-energy-ai"
        
#         data_format = "json"
#         tag_keys = ["ai_model", "prediction_type", "scenario_name", "confidence_level"]
#         json_time_key = "timestamp"
#         json_time_format = "2006-01-02T15:04:05Z07:00"
#         name_override = "energy_ai_data"
        
#         [inputs.mqtt_consumer.tags]
#           source = "energy_ai"
#           component = "predictions"
#           version = "{{ energy_ai.version }}"
#     backup: yes
#   notify: restart telegraf
#   tags: ['telegraf_integration']

# - name: "ğŸ“Š Configuration mÃ©triques performance IA"
#   template:
#     src: configs/ai_metrics.conf.j2
#     dest: /etc/telegraf/telegraf.d/ai_metrics.conf
#     owner: telegraf
#     group: telegraf
#     mode: '0644'
#   notify: restart telegraf
#   tags: ['ai_metrics']

# - name: "ğŸ” Validation configuration Telegraf IA"
#   command: telegraf --config /etc/telegraf/telegraf.d/energy_ai.conf --test
#   register: telegraf_config_test
#   failed_when: telegraf_config_test.rc != 0
#   changed_when: false
#   tags: ['validation']

# - name: "ğŸ“‹ RÃ©sumÃ© configuration Telegraf IA"
#   debug:
#     msg: |
#       âœ… Configuration Telegraf IA dÃ©ployÃ©e:
#       ğŸ“¡ energy_ai.conf - Configuration principale
#       ğŸ—„ï¸ energy_ai_outputs.conf - Outputs InfluxDB
#       ğŸ“Š ai_metrics.conf - MÃ©triques performance
#       ğŸ”§ Extension datacenter_energy.conf - IntÃ©gration
      
#       ğŸ“‹ Validation: {{ 'RÃ‰USSIE' if telegraf_config_test.rc == 0 else 'Ã‰CHOUÃ‰E' }}
#       ğŸ”„ Topics MQTT IA configurÃ©s: {{ mqtt_ai.topics | length }}