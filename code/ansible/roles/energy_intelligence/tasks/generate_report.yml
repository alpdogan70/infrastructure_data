---
# GÃ©nÃ©ration rapport dÃ©ploiement IA Ã©nergÃ©tique
# File: ansible/roles/energy_intelligence/tasks/generate_report.yml

- name: "ğŸ“Š Collecte informations dÃ©ploiement"
  set_fact:
    deployment_info:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      version: "{{ energy_ai.version | default('1.0.0') }}"
      environment: "{{ energy_ai.environment | default('production') }}"
      host: "{{ inventory_hostname }}"
      ip_address: "{{ ansible_default_ipv4.address }}"
      python_version: "{{ python_version_check.stdout | default('Python 3.x') }}"

- name: "ğŸ” VÃ©rification statut services IA"
  systemd:
    name: "{{ item.name }}"
  loop: "{{ energy_ai_services | default([]) }}"
  register: services_status
  ignore_errors: true

- name: "ğŸ“¡ Test connectivitÃ© endpoints"
  uri:
    url: "{{ item.url }}"
    method: GET
    timeout: 5
    status_code: 200
  loop:
    - { name: "InfluxDB", url: "http://{{ influxdb_host }}:8086/health" }
    - { name: "MQTT", url: "http://{{ mqtt_broker_host }}:15672" }
  register: endpoints_status
  ignore_errors: true

- name: "ğŸ’¾ VÃ©rification espace disque"
  setup:
    gather_subset: "!all,hardware"

- name: "ğŸ“‹ GÃ©nÃ©ration rapport complet"
  template:
    src: reports/deployment_report.md.j2
    dest: "{{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/deployment_report_{{ ansible_date_time.date }}.md"
    owner: root
    group: root
    mode: '0644'
  vars:
    services_summary: "{{ services_status.results | default([]) }}"
    endpoints_summary: "{{ endpoints_status.results | default([]) }}"

- name: "ğŸ“§ GÃ©nÃ©ration rapport JSON pour monitoring"
  copy:
    content: |
      {
        "deployment": {
          "status": "{{ 'success' if (services_status.results | selectattr('status.ActiveState', 'equalto', 'active') | list | length) == (energy_ai_services | length) else 'partial' }}",
          "timestamp": "{{ deployment_info.timestamp }}",
          "version": "{{ deployment_info.version }}",
          "environment": "{{ deployment_info.environment }}",
          "host": {
            "name": "{{ deployment_info.host }}",
            "ip": "{{ deployment_info.ip_address }}",
            "python": "{{ deployment_info.python_version }}"
          },
          "services": [
            {% for service in services_status.results | default([]) %}
            {
              "name": "{{ service.item.name }}",
              "status": "{{ service.status.ActiveState | default('unknown') }}",
              "enabled": {{ service.status.UnitFileState == 'enabled' | default(false) | lower }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          "endpoints": [
            {% for endpoint in endpoints_status.results | default([]) %}
            {
              "name": "{{ endpoint.item.name }}",
              "url": "{{ endpoint.item.url }}",
              "status": "{{ 'online' if endpoint.status == 200 else 'offline' }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          "disk_usage": {
            "total_gb": {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first / 1073741824) | round(2) }},
            "available_gb": {{ (ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first / 1073741824) | round(2) }},
            "used_percent": {{ ((ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first) / ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first * 100) | round(1) }}
          }
        }
      }
    dest: "{{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/deployment_status.json"
    owner: root
    group: root
    mode: '0644'

- name: "ğŸ“Š Envoi mÃ©triques dÃ©ploiement vers InfluxDB"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/write"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "text/plain"
    body: |
      energy_ai_deployment,host={{ inventory_hostname }},version={{ energy_ai.version | default('1.0.0') }} deployment_status=1,services_active={{ services_status.results | selectattr('status.ActiveState', 'equalto', 'active') | list | length }},services_total={{ energy_ai_services | length | default(0) }},endpoints_online={{ endpoints_status.results | selectattr('status', 'equalto', 200) | list | length }} {{ ansible_date_time.epoch }}
    query_string:
      org: "{{ influxdb_org }}"
      bucket: "energy_ai"
      precision: "s"
    status_code: 204
  ignore_errors: true

- name: "ğŸ¯ Affichage rapport final"
  debug:
    msg: |
      ğŸ‰ DÃ‰PLOIEMENT ENERGY AI TERMINÃ‰ ğŸ‰
      
      ğŸ“… Date: {{ deployment_info.timestamp }}
      ğŸ·ï¸ Version: {{ deployment_info.version }}
      ğŸŒ Environnement: {{ deployment_info.environment }}
      ğŸ–¥ï¸ Serveur: {{ deployment_info.host }} ({{ deployment_info.ip_address }})
      
      âš™ï¸ Services ({{ services_status.results | selectattr('status.ActiveState', 'equalto', 'active') | list | length }}/{{ energy_ai_services | length | default(0) }} actifs):
      {% for service in services_status.results | default([]) %}
      {{ 'âœ…' if service.status.ActiveState == 'active' else 'âŒ' }} {{ service.item.name }} - {{ service.status.ActiveState | default('unknown') }}
      {% endfor %}
      
      ğŸŒ ConnectivitÃ© ({{ endpoints_status.results | selectattr('status', 'equalto', 200) | list | length }}/{{ endpoints_status.results | length }} OK):
      {% for endpoint in endpoints_status.results | default([]) %}
      {{ 'âœ…' if endpoint.status == 200 else 'âŒ' }} {{ endpoint.item.name }}
      {% endfor %}
      
      ğŸ’¾ Espace disque: {{ ((ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first - ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_available') | first) / ansible_mounts | selectattr('mount', 'equalto', '/') | map(attribute='size_total') | first * 100) | round(1) }}% utilisÃ©
      
      ğŸ“‹ Rapports gÃ©nÃ©rÃ©s:
      ğŸ“„ {{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/deployment_report_{{ ansible_date_time.date }}.md
      ğŸ“Š {{ energy_ai_paths.logs | default('/opt/energy-ai/logs') }}/deployment_status.json
      
      ğŸ”— Dashboards Grafana: http://{{ ansible_default_ipv4.address }}/d/energy-ai-intelligence
      
      {{ 'ğŸ¯ DÃ‰PLOIEMENT RÃ‰USSI!' if (services_status.results | selectattr('status.ActiveState', 'equalto', 'active') | list | length) == (energy_ai_services | length) else 'âš ï¸ DÃ‰PLOIEMENT PARTIEL - VÃ©rifier les services' }}