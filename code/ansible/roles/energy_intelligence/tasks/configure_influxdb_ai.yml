---
# Configuration InfluxDB pour IA Ã©nergÃ©tique (utilise les buckets existants)
# File: ansible/roles/energy_intelligence/tasks/configure_influxdb_ai.yml

- name: "ğŸ” VÃ©rification connectivitÃ© InfluxDB"
  uri:
    url: "http://{{ influxdb_host }}:8086/health"
    method: GET
    status_code: 200
  register: influxdb_health
  retries: 3
  delay: 5

- name: "ğŸ“‹ RÃ©cupÃ©ration ID organisation InfluxDB"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/orgs"
    method: GET
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
    status_code: 200
  register: influxdb_orgs
  when: influxdb_org_id is not defined

- name: "ğŸ¯ Extraction ID organisation"
  set_fact:
    influxdb_org_id: "{{ (influxdb_orgs.json.orgs | selectattr('name', 'equalto', influxdb_org) | first).id }}"
  when: influxdb_org_id is not defined

- name: "ğŸ“Š VÃ©rification des buckets IA existants"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/buckets"
    method: GET
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
    status_code: 200
  register: existing_buckets

- name: "ğŸ” Liste des buckets IA disponibles"
  set_fact:
    ai_buckets_available: "{{ existing_buckets.json.buckets | selectattr('name', 'match', '^(energy_ai|ai_predictions|energy_scenarios|model_performance|carbon_metrics|weather_ml|cost_optimization)$') | map(attribute='name') | list }}"

- name: "âœ… VÃ©rification des buckets IA essentiels"
  assert:
    that:
      - "'energy_ai' in ai_buckets_available"
      - "'ai_predictions' in ai_buckets_available"
      - "'energy_scenarios' in ai_buckets_available"
      - "'model_performance' in ai_buckets_available"
      - "'weather_ml' in ai_buckets_available"
      - "'cost_optimization' in ai_buckets_available"
    fail_msg: |
      âŒ Buckets IA essentiels manquants. Buckets trouvÃ©s: {{ ai_buckets_available }}
      Les buckets IA doivent Ãªtre crÃ©Ã©s par le rÃ´le influxdb_v2
    success_msg: "âœ… Buckets IA essentiels prÃ©sents ({{ ai_buckets_available | length }}/7)"

- name: "âš ï¸ VÃ©rification bucket carbon_metrics (optionnel)"
  debug:
    msg: |
      {% if 'carbon_metrics' in ai_buckets_available %}
      âœ… Bucket carbon_metrics: PrÃ©sent
      {% else %}
      âš ï¸ Bucket carbon_metrics: Manquant (sera crÃ©Ã© automatiquement si nÃ©cessaire)
      {% endif %}

- name: "ğŸ”§ CrÃ©ation du bucket carbon_metrics si manquant"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/buckets"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "carbon_metrics"
      orgID: "{{ influxdb_org_id }}"
      description: "Carbon footprint and sustainability metrics (365 days)"
      retentionRules:
        - type: "expire"
          everySeconds: 31536000  # 365 days
      rp: "autogen"
    status_code: [201, 422]  # 422 si bucket existe dÃ©jÃ 
  when: "'carbon_metrics' not in ai_buckets_available"
  register: carbon_bucket_creation
  ignore_errors: true

- name: "ğŸ“Š Re-vÃ©rification des buckets aprÃ¨s crÃ©ation"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/buckets"
    method: GET
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
    status_code: 200
  register: updated_buckets
  when: carbon_bucket_creation is defined

- name: "ğŸ” Mise Ã  jour de la liste des buckets IA"
  set_fact:
    ai_buckets_available: "{{ updated_buckets.json.buckets | selectattr('name', 'match', '^(energy_ai|ai_predictions|energy_scenarios|model_performance|carbon_metrics|weather_ml|cost_optimization)}"

- name: "âš™ï¸ Configuration datasource Grafana pour IA"
  uri:
    url: "http://{{ grafana_host | default('localhost') }}:3000/api/datasources"
    method: POST
    headers:
      Authorization: "Bearer {{ grafana_admin_token | default('admin') }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "InfluxDB_AI"
      type: "influxdb"
      url: "http://{{ influxdb_host }}:8086"
      access: "proxy"
      database: ""
      jsonData:
        version: "Flux"
        organization: "{{ influxdb_org }}"
        defaultBucket: "energy_ai"
        httpMode: "POST"
      secureJsonData:
        token: "{{ influxdb_token.content | b64decode | trim }}"
    status_code: [200, 409]  # 409 si datasource existe dÃ©jÃ 
  register: grafana_datasource
  ignore_errors: true

- name: "ğŸ§ª Test Ã©criture donnÃ©es IA dans InfluxDB"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/write?org={{ influxdb_org | urlencode }}&bucket=energy_ai&precision=s"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "text/plain"
    body: |
      ai_deployment,source=ansible,component=test ai_status=1,deployment_version="{{ energy_ai.version }}",timestamp={{ ansible_date_time.epoch }}
    status_code: 204
  register: influxdb_write_test

- name: "ğŸ“Š Test lecture donnÃ©es IA"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/query?org={{ influxdb_org | urlencode }}"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "application/vnd.flux"
    body: |
      from(bucket: "energy_ai")
        |> range(start: -5m)
        |> filter(fn: (r) => r._measurement == "ai_deployment")
        |> last()
    status_code: 200
  register: influxdb_read_test

- name: "ğŸ” CrÃ©ation token InfluxDB spÃ©cifique IA (optionnel)"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/authorizations"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      description: "Energy AI Token - {{ ansible_date_time.date }}"
      orgID: "{{ influxdb_org_id }}"
      permissions:
        - action: "read"
          resource:
            type: "buckets"
            orgID: "{{ influxdb_org_id }}"
        - action: "write"
          resource:
            type: "buckets"
            orgID: "{{ influxdb_org_id }}"
    status_code: [201, 422]
  register: ai_token_creation
  when: energy_ai.environment == "production"
  ignore_errors: true

- name: "ğŸ“‹ RÃ©sumÃ© configuration InfluxDB IA"
  debug:
    msg: |
      âœ… Configuration InfluxDB IA terminÃ©e:
      
      ğŸ—„ï¸ Buckets IA disponibles ({{ ai_buckets_available | length }}/7):
      {% for bucket in ai_buckets_available | sort %}
      ğŸ“Š {{ bucket }} - âœ… Disponible
      {% endfor %}
      {% if carbon_bucket_creation is defined and carbon_bucket_creation.status == 201 %}
      
      ğŸ”§ Bucket carbon_metrics crÃ©Ã© automatiquement
      {% endif %}
      
      ğŸ”— ConnectivitÃ©:
      ğŸ“¡ SantÃ© InfluxDB: {{ 'OK' if influxdb_health.status == 200 else 'ERREUR' }}
      âœï¸ Test Ã©criture: {{ 'RÃ‰USSI' if influxdb_write_test.status == 204 else 'Ã‰CHOUÃ‰' }}
      ğŸ“– Test lecture: {{ 'RÃ‰USSI' if influxdb_read_test.status == 200 else 'Ã‰CHOUÃ‰' }}
      
      ğŸ¯ Datasource Grafana: {{ 'CONFIGURÃ‰' if grafana_datasource.status in [200, 409] else 'ERREUR' }}
      ğŸ¢ Organisation: {{ influxdb_org }} ({{ influxdb_org_id[:8] }}...)
      
      ğŸ’¡ Note: Les buckets IA sont gÃ©rÃ©s par le rÃ´le influxdb_v2) | map(attribute='name') | list }}"
  when: updated_buckets is defined

- name: "âš™ï¸ Configuration datasource Grafana pour IA"
  uri:
    url: "http://{{ grafana_host | default('localhost') }}:3000/api/datasources"
    method: POST
    headers:
      Authorization: "Bearer {{ grafana_admin_token | default('admin') }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "InfluxDB_AI"
      type: "influxdb"
      url: "http://{{ influxdb_host }}:8086"
      access: "proxy"
      database: ""
      jsonData:
        version: "Flux"
        organization: "{{ influxdb_org }}"
        defaultBucket: "energy_ai"
        httpMode: "POST"
      secureJsonData:
        token: "{{ influxdb_token.content | b64decode | trim }}"
    status_code: [200, 409]  # 409 si datasource existe dÃ©jÃ 
  register: grafana_datasource
  ignore_errors: true

- name: "ğŸ§ª Test Ã©criture donnÃ©es IA dans InfluxDB"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/write?org={{ influxdb_org | urlencode }}&bucket=energy_ai&precision=s"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "text/plain"
    body: |
      ai_deployment,source=ansible,component=test ai_status=1,deployment_version="{{ energy_ai.version }}",timestamp={{ ansible_date_time.epoch }}
    status_code: 204
  register: influxdb_write_test

- name: "ğŸ“Š Test lecture donnÃ©es IA"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/query?org={{ influxdb_org | urlencode }}"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "application/vnd.flux"
    body: |
      from(bucket: "energy_ai")
        |> range(start: -5m)
        |> filter(fn: (r) => r._measurement == "ai_deployment")
        |> last()
    status_code: 200
  register: influxdb_read_test

- name: "ğŸ” CrÃ©ation token InfluxDB spÃ©cifique IA (optionnel)"
  uri:
    url: "http://{{ influxdb_host }}:8086/api/v2/authorizations"
    method: POST
    headers:
      Authorization: "Token {{ influxdb_token.content | b64decode | trim }}"
      Content-Type: "application/json"
    body_format: json
    body:
      description: "Energy AI Token - {{ ansible_date_time.date }}"
      orgID: "{{ influxdb_org_id }}"
      permissions:
        - action: "read"
          resource:
            type: "buckets"
            orgID: "{{ influxdb_org_id }}"
        - action: "write"
          resource:
            type: "buckets"
            orgID: "{{ influxdb_org_id }}"
    status_code: [201, 422]
  register: ai_token_creation
  when: energy_ai.environment == "production"
  ignore_errors: true

- name: "ğŸ“‹ RÃ©sumÃ© configuration InfluxDB IA"
  debug:
    msg: |
      âœ… Configuration InfluxDB IA terminÃ©e:
      
      ğŸ—„ï¸ Buckets IA disponibles ({{ ai_buckets_available | length }}/7):
      {% for bucket in ai_buckets_available %}
      ğŸ“Š {{ bucket }} - âœ… Disponible
      {% endfor %}
      
      ğŸ”— ConnectivitÃ©:
      ğŸ“¡ SantÃ© InfluxDB: {{ 'OK' if influxdb_health.status == 200 else 'ERREUR' }}
      âœï¸ Test Ã©criture: {{ 'RÃ‰USSI' if influxdb_write_test.status == 204 else 'Ã‰CHOUÃ‰' }}
      ğŸ“– Test lecture: {{ 'RÃ‰USSI' if influxdb_read_test.status == 200 else 'Ã‰CHOUÃ‰' }}
      
      ğŸ¯ Datasource Grafana: {{ 'CONFIGURÃ‰' if grafana_datasource.status in [200, 409] else 'ERREUR' }}
      ğŸ¢ Organisation: {{ influxdb_org }} ({{ influxdb_org_id[:8] }}...)
      
      ğŸ’¡ Note: Les buckets IA sont crÃ©Ã©s par le rÃ´le influxdb_v2