---
# Configuration services système IA
# File: ansible/roles/energy_intelligence/tasks/configure_services.yml

- name: "⚙️ Création services systemd pour IA énergétique"
  template:
    src: "services/{{ item.name }}.service.j2"
    dest: "/etc/systemd/system/{{ item.name }}.service"
    owner: root
    group: root
    mode: '0644'
    backup: yes
  loop: "{{ energy_ai_services }}"
  notify: 
    - reload systemd
    - "restart {{ item.name }}"
  tags: ['systemd']

- name: "🔄 Rechargement daemon systemd"
  systemd:
    daemon_reload: yes

- name: "🔧 Création script de gestion globale IA"
  template:
    src: scripts/manage_energy_ai.sh.j2
    dest: /usr/local/bin/manage_energy_ai
    owner: root
    group: root
    mode: '0755'
  tags: ['scripts']

- name: "📊 Création script de monitoring IA"
  template:
    src: scripts/monitor_energy_ai.sh.j2
    dest: /usr/local/bin/monitor_energy_ai
    owner: root
    group: root
    mode: '0755'
  tags: ['scripts']

- name: "📋 Création script de diagnostics IA"
  template:
    src: scripts/diagnose_energy_ai.sh.j2
    dest: /usr/local/bin/diagnose_energy_ai
    owner: root
    group: root
    mode: '0755'
  tags: ['scripts']

- name: "⏰ Configuration logrotate pour logs IA"
  template:
    src: logrotate/energy_ai.j2
    dest: /etc/logrotate.d/energy_ai
    owner: root
    group: root
    mode: '0644'
  tags: ['logrotate']

- name: "🔍 Vérification configuration services"
  command: "systemd-analyze verify /etc/systemd/system/{{ item.name }}.service"
  loop: "{{ energy_ai_services }}"
  register: systemd_verify
  failed_when: systemd_verify.rc != 0
  changed_when: false
  tags: ['verify']

- name: "📋 Résumé configuration services"
  debug:
    msg: |
      ✅ Services systemd configurés:
      {% for service in energy_ai_services %}
      ⚙️ {{ service.name }}.service - {{ service.description }}
      {% endfor %}
      
      🔧 Scripts de gestion:
      📊 /usr/local/bin/manage_energy_ai - Gestion globale
      📈 /usr/local/bin/monitor_energy_ai - Monitoring
      🔍 /usr/local/bin/diagnose_energy_ai - Diagnostics
      
      📋 Configuration: {{ systemd_verify.results | selectattr('rc', 'equalto', 0) | list | length }}/{{ energy_ai_services | length }} services validés