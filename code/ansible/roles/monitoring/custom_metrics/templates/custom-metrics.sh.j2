#!/bin/bash

######################################
## Script to generate custom metrics
## Version: v1.0.0
######################################

## Variables #########################################

METRICS_DIR="/var/lib/node_exporter"
METRICS_FILE="${METRICS_DIR}/backups-consul.prom"
TOUCH_DIR="/var/lib/cron/"

## Functions #########################################

timestamp_file(){
    timestamp_of_file=$(stat -c %Y $1)
    echo ${timestamp_of_file}
}

editMetric () {
    echo "# HELP $1 $2"
    echo "# TYPE $1 $3"
    echo "$1{$4=\"$5\"} $6"
}

## Let's go #########################################

mkdir -p ${METRICS_DIR}

for file in $(ls ${TOUCH_DIR}/*_*_*.txt);do 
  if [ -f "$file" ];then
    step=$(basename $file | awk -F "_" '{print $1}')
    techno=$(basename $file | awk -F "_" '{print $2}')
    action=$(basename $file | awk -F "_" '{print $3}' | tr -d ".txt")
    METRICS_FILE="${METRICS_DIR}/${step}-${action}-${techno}.prom"
    rm -f ${METRICS_FILE}
    timestamp_file=$(timestamp_file "$file")
    editMetric "${action}_${step}_timestamp" "${step} of ${action} in epoch" "gauge" "${action}" "${techno}" ${timestamp_file} >> ${METRICS_FILE}
  fi
done
